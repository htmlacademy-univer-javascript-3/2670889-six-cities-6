name: Create Previews on PR

on:
  pull_request:
    branches: [master]

jobs:
  chromatic:
    name: Publish to Chromatic
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Publish to Chromatic
        id: chromatic
        uses: chromaui/action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          exitOnceUploaded: true

  codesandbox-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create simplified package.json for CodeSandbox
        run: |
          # –°–æ–∑–¥–∞–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π package.json –¥–ª—è CodeSandbox
          cat package.json | jq '
            del(.scripts.chromatic) |
            .scripts.start = "vite" |
            .scripts.dev = "vite" |
            .scripts.build = "vite build" |
            .scripts.preview = "vite preview"
          ' > package-codesandbox.json
          mv package-codesandbox.json package.json

      - name: Create CodeSandbox configuration
        run: |
          cat > .codesandbox/template.json << EOF
          {
            "title": "Six Cities",
            "description": "React + TypeScript + Vite project",
            "tags": ["react", "typescript", "vite"],
            "published": true
          }
          EOF

      - name: Create archive for CodeSandbox
        run: |
          zip -r codesandbox-upload.zip . \
            -x "*.git*" "node_modules/*" ".github/*" "*.log" "dist/*" "build/*" "coverage/*" "*.env*" "*.md" "*.DS_Store"

      - name: Upload to CodeSandbox
        id: upload-sandbox
        run: |
          RESPONSE=$(curl -s -X POST \
            "https://codesandbox.io/api/v1/sandboxes/define?json=1" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            --data-binary @codesandbox-upload.zip \
            --max-time 60)
          
          echo "API Response: $RESPONSE"
          
          # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –∏–∑–≤–ª–µ—á–µ–Ω–∏—è sandbox_id
          SANDBOX_ID=$(echo "$RESPONSE" | grep -o '"sandbox_id":"[^"]*' | cut -d'"' -f4)
          
          if [ -z "$SANDBOX_ID" ]; then
            SANDBOX_ID=$(echo "$RESPONSE" | grep -o '"id":"[^"]*' | cut -d'"' -f4)
          fi
          
          if [ -z "$SANDBOX_ID" ]; then
            # –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å sandbox, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é —Å—Å—ã–ª–∫—É
            CS_URL="https://githubbox.com/${{ github.repository }}/tree/${{ github.head_ref }}"
            echo "CODESANDBOX_URL=$CS_URL" >> $GITHUB_OUTPUT
            echo "CODESANDBOX_TYPE=githubbox" >> $GITHUB_OUTPUT
          else
            CS_URL="https://codesandbox.io/s/$SANDBOX_ID"
            echo "CODESANDBOX_URL=$CS_URL" >> $GITHUB_OUTPUT
            echo "CODESANDBOX_TYPE=sandbox" >> $GITHUB_OUTPUT
          fi
          
          echo "CodeSandbox URL: $CS_URL"

  comment-previews:
    runs-on: ubuntu-latest
    needs: [chromatic, codesandbox-preview]
    if: always()
    steps:
      - name: Check job statuses
        id: check-status
        run: |
          if [[ "${{ needs.chromatic.result }}" == "success" && "${{ needs.codesandbox-preview.result }}" == "success" ]]; then
            echo "ALL_JOBS_SUCCESS=true" >> $GITHUB_OUTPUT
          else
            echo "ALL_JOBS_SUCCESS=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        if: steps.check-status.outputs.ALL_JOBS_SUCCESS == 'true'
        with:
          script: |
            const csUrl = '${{ needs.codesandbox-preview.outputs.CODESANDBOX_URL }}';
            const csType = '${{ needs.codesandbox-preview.outputs.CODESANDBOX_TYPE }}';
            const chromaticBuildUrl = '${{ needs.chromatic.outputs.STORYBOOK_URL }}';
            const ghPagesUrl = 'https://aasemikov.github.io/2670889-six-cities-6/';
            
            const chromaticProjectUrl = 'https://www.chromatic.com/build?appId=691b0d625e34626933fd4919';
            
            let message = 'üåê **Live Previews:**\n\n';
            
            // Chromatic Storybook
            message += `üé® [Storybook on Chromatic](${chromaticProjectUrl}) - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ UI-—Ç–µ—Å—Ç—ã\n`;
            
            if (chromaticBuildUrl && chromaticBuildUrl.includes('chromatic.com')) {
              message += `   ‚Ü≥ [–¢–µ–∫—É—â–∞—è —Å–±–æ—Ä–∫–∞](${chromaticBuildUrl})\n`;
            }
            
            // CodeSandbox - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–µ —Å—Å—ã–ª–∫–∏
            if (csType === 'sandbox') {
              message += `üì¶ [CodeSandbox](${csUrl}) - –≥–æ—Ç–æ–≤—ã–π sandbox (–ø—É–±–ª–∏—á–Ω—ã–π)\n`;
            } else if (csType === 'githubbox') {
              message += `üì¶ [CodeSandbox](${csUrl}) - —á–µ—Ä–µ–∑ GitHubbox (–ø—É–±–ª–∏—á–Ω—ã–π)\n`;
            } else {
              // Fallback - –ø—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ GitHub –≤ CodeSandbox
              const fallbackUrl = `https://githubbox.com/${context.repo.owner}/${context.repo.repo}/tree/${context.payload.pull_request.head.ref}`;
              message += `üì¶ [CodeSandbox](${fallbackUrl}) - –∏–º–ø–æ—Ä—Ç –∏–∑ GitHub (–ø—É–±–ª–∏—á–Ω—ã–π)\n`;
            }
            
            // GitHub Pages
            message += `üöÄ [GitHub Pages](${ghPagesUrl}) - –¥–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è\n\n`;
            
            message += '---\n';
            message += '_Previews –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø—É—à–µ_';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });