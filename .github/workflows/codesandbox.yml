name: Create Previews on PR

on:
  pull_request:
    branches: [master]

jobs:
  chromatic:
    name: Publish to Chromatic
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Publish to Chromatic
        id: chromatic
        uses: chromaui/action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          exitOnceUploaded: true

  codesandbox-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify project structure
        run: |
          if [ -f "package.json" ]; then
            echo "‚úÖ package.json found"
          else
            echo "‚ùå package.json not found"
            exit 1
          fi

      - name: Create archive and upload to CodeSandbox
        id: upload-sandbox
        run: |
          zip -r codesandbox-upload.zip . \
            -x "*.git*" "node_modules/*" ".github/*" "*.log" "dist/*" "build/*" "coverage/*" "*.env*" "*.md"
          
          RESPONSE=$(curl -s -X POST \
            "https://codesandbox.io/api/v1/sandboxes/define" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            --data @codesandbox-upload.zip \
            --max-time 30)
          
          SANDBOX_ID=$(echo "$RESPONSE" | grep -o '"sandbox_id":"[^"]*' | cut -d'"' -f4)
          
          if [ -n "$SANDBOX_ID" ]; then
            CS_URL="https://codesandbox.io/s/$SANDBOX_ID"
            echo "CODESANDBOX_URL=$CS_URL" >> $GITHUB_OUTPUT
          else
            CS_URL="https://codesandbox.io/p/github/${{ github.repository }}/tree/${{ github.head_ref }}"
            echo "CODESANDBOX_URL=$CS_URL" >> $GITHUB_OUTPUT
          fi

      - name: Upload CodeSandbox URL as artifact
        uses: actions/upload-artifact@v4
        with:
          name: codesandbox-url
          path: |
            !node_modules/
            !.git/
          retention-days: 1

  comment-previews:
    runs-on: ubuntu-latest
    needs: [chromatic, codesandbox-preview]
    if: always()
    steps:
      - name: Check job statuses
        id: check-status
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å—ã –≤—Å–µ—Ö –∑–∞–≤–∏—Å–∏–º—ã—Ö jobs
          if [[ "${{ needs.chromatic.result }}" == "success" && "${{ needs.codesandbox-preview.result }}" == "success" ]]; then
            echo "ALL_JOBS_SUCCESS=true" >> $GITHUB_OUTPUT
          else
            echo "ALL_JOBS_SUCCESS=false" >> $GITHUB_OUTPUT
            echo "Some jobs failed:"
            echo "Chromatic: ${{ needs.chromatic.result }}"
            echo "CodeSandbox: ${{ needs.codesandbox-preview.result }}"
          fi

      - name: Get CodeSandbox URL from previous job
        id: get-cs-url
        run: |
          # –ü–æ–ª—É—á–∞–µ–º URL –∏–∑ outputs –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ job
          CS_URL="${{ needs.codesandbox-preview.outputs.CODESANDBOX_URL }}"
          if [ -n "$CS_URL" ]; then
            echo "CODESANDBOX_URL=$CS_URL" >> $GITHUB_OUTPUT
            echo "Found CodeSandbox URL: $CS_URL"
          else
            # Fallback URL –µ—Å–ª–∏ outputs –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
            CS_URL="https://codesandbox.io/p/github/${{ github.repository }}/tree/${{ github.head_ref }}"
            echo "CODESANDBOX_URL=$CS_URL" >> $GITHUB_OUTPUT
            echo "Using fallback CodeSandbox URL: $CS_URL"
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        if: steps.check-status.outputs.ALL_JOBS_SUCCESS == 'true'
        with:
          script: |
            const csUrl = '${{ steps.get-cs-url.outputs.CODESANDBOX_URL }}';
            const chromaticBuildUrl = '${{ needs.chromatic.outputs.STORYBOOK_URL }}';
            const ghPagesUrl = 'https://aasemikov.github.io/2670889-six-cities-6/';
            
            // –°—Ç–∞—Ç–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –≤–∞—à Chromatic –ø—Ä–æ–µ–∫—Ç
            const chromaticProjectUrl = 'https://www.chromatic.com/build?appId=691b0d625e34626933fd4919';
            
            let message = 'üåê **Live Previews:**\n\n';
            
            // Chromatic Storybook
            message += `üé® [Storybook on Chromatic](${chromaticProjectUrl}) - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ UI-—Ç–µ—Å—Ç—ã\n`;
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Å–±–æ—Ä–∫–∞, –¥–æ–±–∞–≤–ª—è–µ–º –∏ –µ—ë
            if (chromaticBuildUrl && chromaticBuildUrl.includes('chromatic.com')) {
              message += `   ‚Ü≥ [–¢–µ–∫—É—â–∞—è —Å–±–æ—Ä–∫–∞](${chromaticBuildUrl})\n`;
            }
            
            // CodeSandbox - –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ URL –≤–∞–ª–∏–¥–Ω—ã–π
            if (csUrl && csUrl.includes('codesandbox.io')) {
              if (csUrl.includes('/s/')) {
                message += `üì¶ [CodeSandbox](${csUrl}) - –≥–æ—Ç–æ–≤—ã–π sandbox\n`;
              } else {
                message += `üì¶ [CodeSandbox](${csUrl}) - –∏–º–ø–æ—Ä—Ç –∏ –∑–∞–ø—É—Å–∫\n`;
              }
            } else {
              message += `üì¶ [CodeSandbox](https://codesandbox.io/p/github/${{ github.repository }}/tree/${{ github.head_ref }}) - –∏–º–ø–æ—Ä—Ç –∏ –∑–∞–ø—É—Å–∫\n`;
            }
            
            // GitHub Pages
            message += `üöÄ [GitHub Pages](${ghPagesUrl}) - –¥–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è\n\n`;
            
            message += '---\n';
            message += '_Previews –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø—É—à–µ_';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });