name: CodeSandbox Preview

on:
  pull_request:
    branches: [ master, main ]
    types: [opened, synchronize, reopened]

jobs:
  deploy-to-codesandbox:
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.fork == false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Deploy to CodeSandbox
      id: deploy
      uses: codesandbox/deploy-action@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        sandbox_name: "PR-${{ github.event.number }}-${{ github.head_ref }}"
    
    - name: Add CodeSandbox link to PR
      uses: actions/github-script@v7
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          // Check if we already commented
          const existingComment = comments.find(comment => 
            comment.body.includes('CodeSandbox Preview') && 
            comment.user.type === 'Bot'
          );
          
          const commentBody = `## üéØ CodeSandbox Preview
          
            **Live Preview:** ${{ steps.deploy.outputs.sandbox_url }}
                    
            üîó –≠—Ç–∞ —Å—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –ø—Ä–∏ –Ω–æ–≤—ã—Ö –∫–æ–º–º–∏—Ç–∞—Ö –≤ PR.
                    
            _–°–æ–∑–¥–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏_`;
                    
                    if (existingComment) {
                        // Update existing comment
                        await github.rest.issues.updateComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        comment_id: existingComment.id,
                        body: commentBody
                        });
                    } else {
                        // Create new comment
                        await github.rest.issues.createComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: context.issue.number,
                        body: commentBody
                        });
                    }