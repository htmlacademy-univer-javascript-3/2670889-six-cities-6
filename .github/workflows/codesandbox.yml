name: Create CodeSandbox Preview on PR

on:
  pull_request:
    branches: [ master, main ]

jobs:
  codesandbox-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify project structure
        run: |
          echo "üìÅ Checking project files..."
          ls -la
          echo "---"
          if [ -f "package.json" ]; then
            echo "‚úÖ package.json found"
          else
            echo "‚ùå package.json not found - this may cause the error"
            exit 1
          fi

      - name: Create optimized archive for CodeSandbox
        id: create-sandbox
        run: |
          # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ —Ç–æ–ª—å–∫–æ —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏
          zip -r codesandbox-upload.zip . \
            -x "*.git*" \
            -x "node_modules/*" \
            -x ".github/*" \
            -x "*.log" \
            -x "dist/*" \
            -x "build/*" \
            -x "coverage/*" \
            -x "*.env*" \
            -x "*.md"

          echo "üì¶ Archive size: $(du -h codesandbox-upload.zip | cut -f1)"

      - name: Upload to CodeSandbox API
        id: upload-sandbox
        run: |
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π endpoint –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è sandbox
          RESPONSE=$(curl -s -X POST \
            "https://codesandbox.io/api/v1/sandboxes/define" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            --data @codesandbox-upload.zip \
            --max-time 30)
          
          echo "API Response: $RESPONSE"
          
          # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –∏–∑–≤–ª–µ—á–µ–Ω–∏—è sandbox_id
          SANDBOX_ID=$(echo "$RESPONSE" | grep -o '"sandbox_id":"[^"]*' | cut -d'"' -f4)
          
          if [ -z "$SANDBOX_ID" ]; then
            SANDBOX_ID=$(echo "$RESPONSE" | grep -o '"id":"[^"]*' | cut -d'"' -f4)
          fi
          
          if [ -n "$SANDBOX_ID" ]; then
            CS_URL="https://codesandbox.io/s/$SANDBOX_ID"
            echo "CODESANDBOX_URL=$CS_URL" >> $GITHUB_OUTPUT
            echo "‚úÖ Sandbox created: $CS_URL"
          else
            echo "‚ùå Failed to create sandbox"
            echo "Trying alternative method..."
            
            # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± - –∏—Å–ø–æ–ª—å–∑—É–µ–º GitHub –∏–º–ø–æ—Ä—Ç
            CS_URL="https://codesandbox.io/p/github/${{ github.repository }}/${{ github.head_ref }}"
            echo "CODESANDBOX_URL=$CS_URL" >> $GITHUB_OUTPUT
            echo "üîó Fallback URL: $CS_URL"
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        if: success()
        with:
          script: |
            const csUrl = '${{ steps.upload-sandbox.outputs.CODESANDBOX_URL }}';
            
            let message = 'üöÄ **CodeSandbox Preview**\\n\\n';
            
            if (csUrl.includes('/s/')) {
              message += `üì¶ [–û—Ç–∫—Ä—ã—Ç—å –≥–æ—Ç–æ–≤—ã–π Sandbox](${csUrl})\\n\\n`;
              message += '_–°–∞–Ω–¥–±–æ–∫—Å —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ_';
            } else {
              message += `üîó [–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ CodeSandbox](${csUrl})\\n\\n`;
              message += '_–ù–∞–∂–º–∏—Ç–µ "Import and Fork" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è sandbox_';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });