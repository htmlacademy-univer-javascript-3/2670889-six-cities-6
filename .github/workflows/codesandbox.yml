name: Create Previews on PR

on:
  pull_request:
    branches: [master]

jobs:
  chromatic:
    name: Publish to Chromatic
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Publish to Chromatic
        id: chromatic
        uses: chromaui/action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          exitOnceUploaded: true

  codesandbox-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate GitHubbox URL
        id: githubbox
        run: |
          # –ü—Ä–æ—Å—Ç–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º URL GitHubbox - –æ–Ω –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
          CS_URL="https://githubbox.com/${{ github.repository }}/tree/${{ github.head_ref }}"
          echo "CODESANDBOX_URL=$CS_URL" >> $GITHUB_OUTPUT
          echo "CodeSandbox URL: $CS_URL"

      - name: Upload URL as artifact (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
        uses: actions/upload-artifact@v4
        with:
          name: codesandbox-url
          path: .
          retention-days: 1

  comment-previews:
    runs-on: ubuntu-latest
    needs: [chromatic, codesandbox-preview]
    steps:
      - name: Debug outputs
        run: |
          echo "=== Debug outputs ==="
          echo "Chromatic result: ${{ needs.chromatic.result }}"
          echo "CodeSandbox result: ${{ needs.codesandbox-preview.result }}"
          echo "CodeSandbox URL from outputs: ${{ needs.codesandbox-preview.outputs.CODESANDBOX_URL }}"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ PR
            const prNumber = context.issue.number;
            const repo = context.repo;
            const branch = context.payload.pull_request.head.ref;
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º URL –Ω–∞–ø—Ä—è–º—É—é
            const csUrl = `https://githubbox.com/${repo.owner}/${repo.repo}/tree/${branch}`;
            const chromaticBuildUrl = '${{ needs.chromatic.outputs.STORYBOOK_URL }}';
            const ghPagesUrl = 'https://aasemikov.github.io/2670889-six-cities-6/';
            
            const chromaticProjectUrl = 'https://www.chromatic.com/build?appId=691b0d625e34626933fd4919';
            
            let message = 'üåê **Live Previews:**\n\n';
            
            // Chromatic Storybook
            message += `üé® [Storybook on Chromatic](${chromaticProjectUrl}) - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ UI-—Ç–µ—Å—Ç—ã\n`;
            
            if (chromaticBuildUrl && chromaticBuildUrl.includes('chromatic.com')) {
              message += `   ‚Ü≥ [–¢–µ–∫—É—â–∞—è —Å–±–æ—Ä–∫–∞](${chromaticBuildUrl})\n`;
            } else {
              message += `   ‚Ü≥ –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è...\n`;
            }
            
            // CodeSandbox - –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º GitHubbox
            message += `üì¶ [CodeSandbox](${csUrl}) - –∑–∞–ø—É—Å–∫ –≤ –±—Ä–∞—É–∑–µ—Ä–µ\n`;
            
            // GitHub Pages
            message += `üöÄ [GitHub Pages](${ghPagesUrl}) - –¥–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è\n\n`;
            
            message += '---\n';
            message += '_Previews –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏_';
            
            console.log('Comment message:', message);
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: repo.owner,
              repo: repo.repo,
              body: message
            });