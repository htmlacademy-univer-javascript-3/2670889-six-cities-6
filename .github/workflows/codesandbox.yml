name: Create CodeSandbox Preview on PR

on:
  pull_request:
    branches: [ master, main ]

jobs:
  codesandbox-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify project structure
        run: |
          if [ -f "package.json" ]; then
            echo "‚úÖ package.json found"
          else
            echo "‚ùå package.json not found"
            exit 1
          fi

      - name: Create archive and upload to CodeSandbox
        id: upload-sandbox
        run: |
          zip -r codesandbox-upload.zip . \
            -x "*.git*" "node_modules/*" ".github/*" "*.log" "dist/*" "build/*" "coverage/*" "*.env*" "*.md"
          
          RESPONSE=$(curl -s -X POST \
            "https://codesandbox.io/api/v1/sandboxes/define" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            --data @codesandbox-upload.zip \
            --max-time 30)
          
          SANDBOX_ID=$(echo "$RESPONSE" | grep -o '"sandbox_id":"[^"]*' | cut -d'"' -f4)
          
          if [ -n "$SANDBOX_ID" ]; then
            CS_URL="https://codesandbox.io/s/$SANDBOX_ID"
            echo "CODESANDBOX_URL=$CS_URL" >> $GITHUB_OUTPUT
          else
            CS_URL="https://codesandbox.io/p/github/${{ github.repository }}/${{ github.head_ref }}"
            echo "CODESANDBOX_URL=$CS_URL" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        if: success()
        with:
          script: |
            const csUrl = '${{ steps.upload-sandbox.outputs.CODESANDBOX_URL }}';
            const ghPagesUrl = 'https://aasemikov.github.io/2670889-six-cities-6/';
            
            let message = 'üåê **Live Previews:**\n\n';
            
            if (csUrl.includes('/s/')) {
              message += `üì¶ [CodeSandbox](${csUrl}) - –≥–æ—Ç–æ–≤—ã–π sandbox\n`;
            } else {
              message += `üì¶ [CodeSandbox](${csUrl}) - –∏–º–ø–æ—Ä—Ç –∏ –∑–∞–ø—É—Å–∫\n`;
            }
            
            message += `üöÄ [GitHub Pages](${ghPagesUrl}) - –¥–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è\n\n`;
            message += '_Previews –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏_';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });