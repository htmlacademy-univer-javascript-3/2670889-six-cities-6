name: Create CodeSandbox Preview on PR

on:
  pull_request:
    branches: [ master, main ]

jobs:
  codesandbox-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create CodeSandbox sandbox via API
        id: create-sandbox
        run: |
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∞—Ä—Ö–∏–≤ —Å –∫–æ–¥–æ–º
          zip -r codesandbox-upload.zip . -x '*.git*' 'node_modules/*'
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ CodeSandbox API
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            --data-binary @codesandbox-upload.zip \
            "https://codesandbox.io/api/v1/sandboxes/define?json=1")
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º ID —Å–∞–Ω–¥–±–æ–∫—Å–∞
          SANDBOX_ID=$(echo $RESPONSE | grep -o '"sandbox_id":"[^"]*' | cut -d'"' -f4)
          
          if [ -n "$SANDBOX_ID" ]; then
            CS_URL="https://codesandbox.io/s/$SANDBOX_ID"
            echo "CODESANDBOX_URL=$CS_URL" >> $GITHUB_OUTPUT
            echo "‚úÖ Sandbox created: $CS_URL"
          else
            echo "‚ùå Failed to create sandbox"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        if: success()
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üéâ **CodeSandbox Preview Created!**\n\nüîó [Open Preview](${{ steps.create-sandbox.outputs.CO DESANDBOX_URL }})\n\n_–°—Å—ã–ª–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏–∑ —ç—Ç–æ–≥–æ PR_`
            })