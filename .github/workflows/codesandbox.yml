name: Create Previews on PR

on:
  pull_request:
    branches: [master]

jobs:
  chromatic:
    name: Publish to Chromatic
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Publish to Chromatic
        id: chromatic
        uses: chromaui/action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          exitOnceUploaded: true

  codesandbox-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify project structure
        run: |
          if [ -f "package.json" ]; then
            echo "‚úÖ package.json found"
          else
            echo "‚ùå package.json not found"
            exit 1
          fi

      - name: Create archive and upload to CodeSandbox
        id: upload-sandbox
        run: |
          zip -r codesandbox-upload.zip . \
            -x "*.git*" "node_modules/*" ".github/*" "*.log" "dist/*" "build/*" "coverage/*" "*.env*" "*.md"
          
          RESPONSE=$(curl -s -X POST \
            "https://codesandbox.io/api/v1/sandboxes/define" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            --data @codesandbox-upload.zip \
            --max-time 30)
          
          SANDBOX_ID=$(echo "$RESPONSE" | grep -o '"sandbox_id":"[^"]*' | cut -d'"' -f4)
          
          if [ -n "$SANDBOX_ID" ]; then
            CS_URL="https://codesandbox.io/s/$SANDBOX_ID"
            echo "CODESANDBOX_URL=$CS_URL" >> $GITHUB_OUTPUT
          else
            CS_URL="https://codesandbox.io/p/github/${{ github.repository }}/${{ github.head_ref }}"
            echo "CODESANDBOX_URL=$CS_URL" >> $GITHUB_OUTPUT
          fi

  comment-previews:
    runs-on: ubuntu-latest
    needs: [chromatic, codesandbox-preview]
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const csUrl = '${{ steps.upload-sandbox.outputs.CODESANDBOX_URL }}';
            const chromaticUrl = '${{ steps.chromatic.outputs.STORYBOOK_URL }}';
            const ghPagesUrl = 'https://aasemikov.github.io/2670889-six-cities-6/';
            
            let message = 'üåê **Live Previews:**\n\n';
            
            // Chromatic Storybook
            if (chromaticUrl) {
              message += `üé® [Storybook on Chromatic](${chromaticUrl}) - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ UI-—Ç–µ—Å—Ç—ã\n`;
            }
            
            // CodeSandbox
            if (csUrl.includes('/s/')) {
              message += `üì¶ [CodeSandbox](${csUrl}) - –≥–æ—Ç–æ–≤—ã–π sandbox\n`;
            } else {
              message += `üì¶ [CodeSandbox](${csUrl}) - –∏–º–ø–æ—Ä—Ç –∏ –∑–∞–ø—É—Å–∫\n`;
            }
            
            // GitHub Pages
            message += `üöÄ [GitHub Pages](${ghPagesUrl}) - –¥–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è\n\n`;
            
            message += '---\n';
            message += '_Previews –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø—É—à–µ_';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });