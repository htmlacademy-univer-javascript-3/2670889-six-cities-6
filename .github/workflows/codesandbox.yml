name: Create Previews on PR

on:
  pull_request:
    branches: [master]

jobs:
  chromatic:
    name: Publish to Chromatic
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Publish to Chromatic
        id: chromatic
        uses: chromaui/action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          exitOnceUploaded: true

  codesandbox-preview:
    runs-on: ubuntu-latest
    outputs:
      CODESANDBOX_URL: ${{ steps.deploy-sandbox.outputs.codesandbox-url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install CodeSandbox CLI
        run: npm install -g @codesandbox/sandpack-cli

      - name: Create sandbox configuration (if missing)
        run: |
          # –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è CodeSandbox –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
          if [ ! -f sandbox.config.json ]; then
            cat > sandbox.config.json << EOF
          {
            "infiniteLoopProtection": true,
            "hardReloadOnChange": false,
            "view": "browser",
            "template": "node",
            "container": {
              "node": "16"
            }
          }
          EOF
          fi

      - name: Deploy to CodeSandbox
        id: deploy-sandbox
        env:
          CODESANDBOX_TOKEN: ${{ secrets.CODESANDBOX_TOKEN }}
        run: |
          echo "Deploying to CodeSandbox..."
          
          # –î–µ–ø–ª–æ–∏–º —Å –ø–æ–º–æ—â—å—é CLI
          DEPLOY_RESULT=$(npx @codesandbox/sandpack-cli deploy . --token $CODESANDBOX_TOKEN --name "PR-${{ github.head_ref }}-${{ github.run_id }}" --public --output json)
          
          echo "Deploy result: $DEPLOY_RESULT"
          
          # –ü–∞—Ä—Å–∏–º JSON –≤—ã–≤–æ–¥ —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å URL
          CSB_URL=$(echo $DEPLOY_RESULT | python3 -c "import sys, json; print(json.load(sys.stdin)['url'])")
          
          # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –µ—Å–ª–∏ python –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–∏—Å–ø–æ–ª—å–∑—É–µ–º jq)
          # CSB_URL=$(echo $DEPLOY_RESULT | jq -r '.url')
          
          echo "CodeSandbox URL: $CSB_URL"
          echo "codesandbox-url=$CSB_URL" >> $GITHUB_OUTPUT

      - name: Fallback deployment (if CLI fails)
        if: steps.deploy-sandbox.outcome == 'failure'
        id: fallback-deploy
        env:
          CODESANDBOX_TOKEN: ${{ secrets.CODESANDBOX_TOKEN }}
        run: |
          echo "Trying alternative deployment method..."
          
          # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± —á–µ—Ä–µ–∑ zip –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ
          zip -r deploy.zip . -x "*.git*" "node_modules/*" "*.github/*"
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º curl –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ CodeSandbox
          RESPONSE=$(curl -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $CODESANDBOX_TOKEN" \
            -d '{
              "name": "PR-'${{ github.head_ref }}'-'${{ github.run_id }}'",
              "is_public": true
            }' \
            "https://codesandbox.io/api/v1/sandboxes/define?json=1")
          
          SANDBOX_ID=$(echo $RESPONSE | python3 -c "import sys, json; print(json.load(sys.stdin)['sandbox_id'])")
          CSB_URL="https://$SANDBOX_ID.sse.codesandbox.io"
          
          echo "Alternative CodeSandbox URL: $CSB_URL"
          echo "codesandbox-url=$CSB_URL" >> $GITHUB_OUTPUT

  comment-previews:
    runs-on: ubuntu-latest
    needs: [chromatic, codesandbox-preview]
    if: always()
    steps:
      - name: Create or update PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const repo = context.repo;
            const branch = context.payload.pull_request.head.ref;
            
            // –ü–æ–ª—É—á–∞–µ–º URL –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö jobs
            const chromaticUrl = '${{ needs.chromatic.outputs.STORYBOOK_URL }}';
            const codesandboxUrl = '${{ needs.codesandbox-preview.outputs.CODESANDBOX_URL }}';
            const ghPagesUrl = 'https://aasemikov.github.io/2670889-six-cities-6/';
            const chromaticProjectUrl = 'https://www.chromatic.com/build?appId=691b0d625e34626933fd4919';
            
            let message = 'üåê **Live Previews:**\n\n';
            
            // Chromatic Storybook
            message += `üé® **Storybook Components**\n`;
            if (chromaticUrl && chromaticUrl.includes('chromatic.com')) {
              message += `‚Ä¢ [View Storybook](${chromaticUrl}) - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ UI-—Ç–µ—Å—Ç—ã\n`;
            }
            message += `‚Ä¢ [Chromatic Project](${chromaticProjectUrl}) - –≤—Å–µ —Å–±–æ—Ä–∫–∏\n`;
            
            // CodeSandbox
            message += `\nüì¶ **Interactive Sandbox**\n`;
            if (codesandboxUrl && codesandboxUrl.includes('codesandbox.io')) {
              message += `‚Ä¢ [Open in CodeSandbox](${codesandboxUrl}) - –ø–æ–ª–Ω–∞—è –ø–µ—Å–æ—á–Ω–∏—Ü–∞\n`;
            }
            
            // GitHubbox (–≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω)
            const githubboxUrl = `https://githubbox.com/${repo.owner}/${repo.repo}/tree/${branch}`;
            message += `‚Ä¢ [Quick GitHubbox](${githubboxUrl}) - –±—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä\n`;
            
            // GitHub Pages
            message += `\nüöÄ **Production Build**\n`;
            message += `‚Ä¢ [GitHub Pages](${ghPagesUrl}) - —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è\n`;
            
            message += '\n---\n';
            message += '_Previews –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø—É—à–µ –≤ PR_';
            
            // –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å previews
            const { data: comments } = await github.rest.issues.listComments({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: prNumber
            });
            
            const existingComment = comments.find(comment => 
              comment.body.includes('üåê **Live Previews:**') && 
              comment.user.type === 'Bot'
            );
            
            if (existingComment) {
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
              await github.rest.issues.updateComment({
                owner: repo.owner,
                repo: repo.repo,
                comment_id: existingComment.id,
                body: message
              });
              console.log('Updated existing comment');
            } else {
              // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
              await github.rest.issues.createComment({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: prNumber,
                body: message
              });
              console.log('Created new comment');
            }